# 2024.04.19 ansible 4일차

- 교재: Learning Ansible 2.7 - Third Edition [(packtpub)](https://www.packtpub.com/product/learning-ansible-27-third-edition/9781789954333) [(github)](https://github.com/PacktPublishing/Learning-Ansible-2.X-Third-Edition)

- WSL로 진행하니 PC 재부팅하면 컨테이너로 SSH 접속힐 때 다체로운 오류가 발생한다. (key 재설정 작업을 하면 되는데, 매번 하려니 지친다.)
- 환경 설정의 번거로움 oracle cloud vm 에서 환경 재구성하였다.

**여기까지 했음 - 2024-04-16**

* https://subscription.packtpub.com/book/cloud-and-networking/9781789954333/3/ch03lvl1sec20/installing-and-configuring-a-web-server
* /home/opc/Learning-Ansible-2.X-Third-Edition-master/Chapter02


```bash
docker run -d --privileged --name test01 centos:centos7 /usr/sbin/init
cat <<EOF > ./centos7_vagrant
mv /usr/bin/systemctl /usr/bin/systemctl.old;
curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl;
chmod +x /usr/bin/systemctl;
yum install -y iproute net-tools openssh-server sudo;
ssh-keygen -A;
sed -i "s/#UseDNS yes/UseDNS no/g" /etc/ssh/sshd_config
sed -i "s/#UseDNS no/UseDNS no/g" /etc/ssh/sshd_config
systemctl enable sshd; systemctl restart sshd;
useradd vagrant
echo "vagrant" | passwd --stdin vagrant
chmod u+w /etc/sudoers.d
echo "vagrant        ALL=NOPASSWD:       ALL" >> /etc/sudoers.d/vagrant
chmod u-w /etc/sudoers.d
EOF
docker cp ./centos7_vagrant test01:/root/centos7_vagrant.sh
docker exec -u 0 test01 /bin/bash /root/centos7_vagrant.sh


sshpass -p vagrant ssh-copy-id -f -i ~/.ssh/id_rsa vagrant@`docker inspect -f "{{ .NetworkSettings.IPAddress }}" test01`
echo "`docker inspect -f "{{ .NetworkSettings.IPAddress }}" test01` test01.fale.io" | sudo tee -a /etc/hosts
```



https://subscription.packtpub.com/book/cloud-and-networking/9781789954333/3/ch03lvl1sec17/variables-in-playbooks


```bash
[opc@instance-20220112-0945 Chapter02]$ ansible all -i test01.fale.io, -u vagrant -m ping
test01.fale.io | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
[opc@instance-20220112-0945 Chapter02]$
```


```bash
[opc@instance-20220112-0945 Chapter02]$ cat variables.yaml
--- 
- hosts: all 
  remote_user: vagrant
  tasks: 
    - name: Set variable 'name' 
      set_fact: 
        name: Test machine 
    - name: Print variable 'name' 
      debug: 
        msg: '{{ name }}' 
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook -i test01.fale.io, variables.yaml

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Set variable 'name'] **************************************************************************************************************************************ok: [test01.fale.io]

TASK [Print variable 'name'] ************************************************************************************************************************************ok: [test01.fale.io] => {
    "msg": "Test machine"
}

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter02]$ 
```


```bash
[opc@instance-20220112-0945 Chapter02]$ ansible all -i test01.fale.io, -m setup
test01.fale.io | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).", 
    "unreachable": true
}
[opc@instance-20220112-0945 Chapter02]$ ansible all -i test01.fale.io, -u vagrant -m setup
test01.fale.io | SUCCESS => {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "172.17.0.5"
        ], 
        "ansible_all_ipv6_addresses": [], 
        "ansible_apparmor": {
            "status": "disabled"
        }, 
        "ansible_architecture": "x86_64", 
        "ansible_bios_date": "08/22/2023", 
        "ansible_bios_version": "1.6.6", 
        "ansible_cmdline": {
            "BOOT_IMAGE": "/boot/vmlinuz-5.4.17-2136.301.1.3.el7uek.x86_64", 
            "LANG": "en_US.UTF-8", 
            "console": "ttyS0,115200", 
            "crash_kexec_post_notifiers": true, 
            "crashkernel": "auto", 
            "ip": "single-dhcp", 
            "ipmi_si.tryacpi": "0", 
            "ipmi_si.trydmi": "0", 
            "iscsi_param": "node.session.timeo.replacement_timeout=6000", 
            "libiscsi.debug_libiscsi_eh": "1", 
            "loglevel": "4", 
            "net.ifnames": "1", 
            "netroot": "iscsi:169.254.0.2:::1:iqn.2015-02.oracle.boot:uefi", 
            "nvme_core.shutdown_timeout": "10", 
            "rd.dm": "0", 
            "rd.iscsi.bypass": "1", 
            "rd.luks": "0", 
            "rd.lvm": "0", 
            "rd.md": "0", 
            "ro": true, 
            "root": "UUID=daec0eb0-26cf-43cb-bcb1-896cdc193242"
        }, 
        "ansible_date_time": {
            "date": "2024-04-19", 
            "day": "19", 
            "epoch": "1713514636", 
            "hour": "08", 
            "iso8601": "2024-04-19T08:17:16Z", 
            "iso8601_basic": "20240419T081716040669", 
            "iso8601_basic_short": "20240419T081716", 
            "iso8601_micro": "2024-04-19T08:17:16.040669Z", 
            "minute": "17", 
            "month": "04", 
            "second": "16", 
            "time": "08:17:16", 
            "tz": "UTC", 
            "tz_offset": "+0000", 
            "weekday": "Friday", 
            "weekday_number": "5", 
            "weeknumber": "16", 
            "year": "2024"
        }, 
        "ansible_default_ipv4": {
            "address": "172.17.0.5", 
            "alias": "eth0", 
            "broadcast": "172.17.255.255", 
            "gateway": "172.17.0.1", 
            "interface": "eth0", 
            "macaddress": "02:42:ac:11:00:05", 
            "mtu": 1500, 
            "netmask": "255.255.0.0", 
            "network": "172.17.0.0", 
            "type": "ether"
        }, 
        "ansible_default_ipv6": {}, 
        "ansible_device_links": {
            "ids": {
                "sda": [
                    "scsi-360add63a891c465aa364f390de842533", 
                    "wwn-0x60add63a891c465aa364f390de842533"
                ], 
                "sda1": [
                    "scsi-360add63a891c465aa364f390de842533-part1", 
                    "wwn-0x60add63a891c465aa364f390de842533-part1"
                ], 
                "sda2": [
                    "scsi-360add63a891c465aa364f390de842533-part2", 
                    "wwn-0x60add63a891c465aa364f390de842533-part2"
                ], 
                "sda3": [
                    "scsi-360add63a891c465aa364f390de842533-part3", 
                    "wwn-0x60add63a891c465aa364f390de842533-part3"
                ]
            }, 
            "labels": {}, 
            "masters": {}, 
            "uuids": {
                "sda1": [
                    "61E0-20B8"
                ], 
                "sda2": [
                    "7c02c8fa-405c-4583-bf26-72fcfff63ccf"
                ], 
                "sda3": [
                    "daec0eb0-26cf-43cb-bcb1-896cdc193242"
                ]
            }
        }, 
        "ansible_devices": {
            "sda": {
                "holders": [], 
                "host": "", 
                "links": {
                    "ids": [
                        "scsi-360add63a891c465aa364f390de842533", 
                        "wwn-0x60add63a891c465aa364f390de842533"
                    ], 
                    "labels": [], 
                    "masters": [], 
                    "uuids": []
                }, 
                "model": "BlockVolume", 
                "partitions": {
                    "sda1": {
                        "holders": [], 
                        "links": {
                            "ids": [
                                "scsi-360add63a891c465aa364f390de842533-part1", 
                                "wwn-0x60add63a891c465aa364f390de842533-part1"
                            ], 
                            "labels": [], 
                            "masters": [], 
                            "uuids": [
                                "61E0-20B8"
                            ]
                        }, 
                        "sectors": "409600", 
                        "sectorsize": 512, 
                        "size": "200.00 MB", 
                        "start": "2048", 
                        "uuid": "61E0-20B8"
                    }, 
                    "sda2": {
                        "holders": [], 
                        "links": {
                            "ids": [
                                "scsi-360add63a891c465aa364f390de842533-part2", 
                                "wwn-0x60add63a891c465aa364f390de842533-part2"
                            ], 
                            "labels": [], 
                            "masters": [], 
                            "uuids": [
                                "7c02c8fa-405c-4583-bf26-72fcfff63ccf"
                            ]
                        }, 
                        "sectors": "16777216", 
                        "sectorsize": 512, 
                        "size": "8.00 GB", 
                        "start": "411648", 
                        "uuid": "7c02c8fa-405c-4583-bf26-72fcfff63ccf"
                    }, 
                    "sda3": {
                        "holders": [], 
                        "links": {
                            "ids": [
                                "scsi-360add63a891c465aa364f390de842533-part3", 
                                "wwn-0x60add63a891c465aa364f390de842533-part3"
                            ], 
                            "labels": [], 
                            "masters": [], 
                            "uuids": [
                                "daec0eb0-26cf-43cb-bcb1-896cdc193242"
                            ]
                        }, 
                        "sectors": "80486400", 
                        "sectorsize": 512, 
                        "size": "38.38 GB", 
                        "start": "17188864", 
                        "uuid": "daec0eb0-26cf-43cb-bcb1-896cdc193242"
                    }
                }, 
                "removable": "0", 
                "rotational": "1", 
                "sas_address": null, 
                "sas_device_handle": null, 
                "scheduler_mode": "mq-deadline", 
                "sectors": "97677312", 
                "sectorsize": "512", 
                "size": "46.58 GB", 
                "support_discard": "32768", 
                "vendor": "ORACLE", 
                "virtual": 1, 
                "wwn": "0x60add63a891c465aa364f390de842533"
            }
        }, 
        "ansible_distribution": "CentOS", 
        "ansible_distribution_file_parsed": true, 
        "ansible_distribution_file_path": "/etc/redhat-release", 
        "ansible_distribution_file_variety": "RedHat", 
        "ansible_distribution_major_version": "7", 
        "ansible_distribution_release": "Core", 
        "ansible_distribution_version": "7.9", 
        "ansible_dns": {
            "nameservers": [
                "169.254.169.254"
            ], 
            "search": [
                "vcn01120944.oraclevcn.com", 
                "subnet01120944.vcn01120944.oraclevcn.com"
            ]
        }, 
        "ansible_domain": "", 
        "ansible_effective_group_id": 1000, 
        "ansible_effective_user_id": 1000, 
        "ansible_env": {
            "HOME": "/home/vagrant", 
            "LANG": "en_US.UTF-8", 
            "LOGNAME": "vagrant", 
            "LS_COLORS": "rs=0:di=38;5;27:ln=38;5;51:mh=44;38;5;15:pi=40;38;5;11:so=38;5;13:do=38;5;5:bd=48;5;232;38;5;11:cd=48;5;232;38;5;3:or=48;5;232;38;5;9:mi=05;48;5;232;38;5;15:su=48;5;196;38;5;15:sg=48;5;11;38;5;16:ca=48;5;196;38;5;226:tw=48;5;10;38;5;16:ow=48;5;10;38;5;21:st=48;5;21;38;5;15:ex=38;5;34:*.tar=38;5;9:*.tgz=38;5;9:*.arc=38;5;9:*.arj=38;5;9:*.taz=38;5;9:*.lha=38;5;9:*.lz4=38;5;9:*.lzh=38;5;9:*.lzma=38;5;9:*.tlz=38;5;9:*.txz=38;5;9:*.tzo=38;5;9:*.t7z=38;5;9:*.zip=38;5;9:*.z=38;5;9:*.Z=38;5;9:*.dz=38;5;9:*.gz=38;5;9:*.lrz=38;5;9:*.lz=38;5;9:*.lzo=38;5;9:*.xz=38;5;9:*.bz2=38;5;9:*.bz=38;5;9:*.tbz=38;5;9:*.tbz2=38;5;9:*.tz=38;5;9:*.deb=38;5;9:*.rpm=38;5;9:*.jar=38;5;9:*.war=38;5;9:*.ear=38;5;9:*.sar=38;5;9:*.rar=38;5;9:*.alz=38;5;9:*.ace=38;5;9:*.zoo=38;5;9:*.cpio=38;5;9:*.7z=38;5;9:*.rz=38;5;9:*.cab=38;5;9:*.jpg=38;5;13:*.jpeg=38;5;13:*.gif=38;5;13:*.bmp=38;5;13:*.pbm=38;5;13:*.pgm=38;5;13:*.ppm=38;5;13:*.tga=38;5;13:*.xbm=38;5;13:*.xpm=38;5;13:*.tif=38;5;13:*.tiff=38;5;13:*.png=38;5;13:*.svg=38;5;13:*.svgz=38;5;13:*.mng=38;5;13:*.pcx=38;5;13:*.mov=38;5;13:*.mpg=38;5;13:*.mpeg=38;5;13:*.m2v=38;5;13:*.mkv=38;5;13:*.webm=38;5;13:*.ogm=38;5;13:*.mp4=38;5;13:*.m4v=38;5;13:*.mp4v=38;5;13:*.vob=38;5;13:*.qt=38;5;13:*.nuv=38;5;13:*.wmv=38;5;13:*.asf=38;5;13:*.rm=38;5;13:*.rmvb=38;5;13:*.flc=38;5;13:*.avi=38;5;13:*.fli=38;5;13:*.flv=38;5;13:*.gl=38;5;13:*.dl=38;5;13:*.xcf=38;5;13:*.xwd=38;5;13:*.yuv=38;5;13:*.cgm=38;5;13:*.emf=38;5;13:*.axv=38;5;13:*.anx=38;5;13:*.ogv=38;5;13:*.ogx=38;5;13:*.aac=38;5;45:*.au=38;5;45:*.flac=38;5;45:*.mid=38;5;45:*.midi=38;5;45:*.mka=38;5;45:*.mp3=38;5;45:*.mpc=38;5;45:*.ogg=38;5;45:*.ra=38;5;45:*.wav=38;5;45:*.axa=38;5;45:*.oga=38;5;45:*.spx=38;5;45:*.xspf=38;5;45:", 
            "MAIL": "/var/mail/vagrant", 
            "PATH": "/usr/local/bin:/usr/bin", 
            "PWD": "/home/vagrant", 
            "SHELL": "/bin/bash", 
            "SHLVL": "2", 
            "SSH_CLIENT": "172.17.0.1 40174 22", 
            "SSH_CONNECTION": "172.17.0.1 40174 172.17.0.5 22", 
            "SSH_TTY": "/dev/pts/0", 
            "TERM": "xterm-256color", 
            "USER": "vagrant", 
            "XDG_RUNTIME_DIR": "/run/user/1000", 
            "XDG_SESSION_ID": "29648", 
            "_": "/usr/bin/python"
        }, 
        "ansible_eth0": {
            "active": true, 
            "device": "eth0", 
            "ipv4": {
                "address": "172.17.0.5", 
                "broadcast": "172.17.255.255", 
                "netmask": "255.255.0.0", 
                "network": "172.17.0.0"
            }, 
            "macaddress": "02:42:ac:11:00:05", 
            "mtu": 1500, 
            "promisc": false, 
            "speed": 10000, 
            "type": "ether"
        }, 
        "ansible_fibre_channel_wwn": [], 
        "ansible_fips": false, 
        "ansible_form_factor": "Other", 
        "ansible_fqdn": "63c835d7627e", 
        "ansible_hostname": "63c835d7627e", 
        "ansible_hostnqn": "", 
        "ansible_interfaces": [
            "lo", 
            "eth0"
        ], 
        "ansible_is_chroot": true, 
        "ansible_iscsi_iqn": "", 
        "ansible_kernel": "5.4.17-2136.301.1.3.el7uek.x86_64", 
        "ansible_kernel_version": "#2 SMP Mon Nov 29 20:54:48 PST 2021", 
        "ansible_lo": {
            "active": true, 
            "device": "lo", 
            "ipv4": {
                "address": "127.0.0.1", 
                "broadcast": "", 
                "netmask": "255.0.0.0", 
                "network": "127.0.0.0"
            }, 
            "mtu": 65536, 
            "promisc": false, 
            "type": "loopback"
        }, 
        "ansible_local": {}, 
        "ansible_lsb": {}, 
        "ansible_machine": "x86_64", 
        "ansible_machine_id": "29a843629874492885b239d9557be885", 
        "ansible_memfree_mb": 50, 
        "ansible_memory_mb": {
            "nocache": {
                "free": 179, 
                "used": 501
            }, 
            "real": {
                "free": 50, 
                "total": 680, 
                "used": 630
            }, 
            "swap": {
                "cached": 36, 
                "free": 7838, 
                "total": 8191, 
                "used": 353
            }
        }, 
        "ansible_memtotal_mb": 680, 
        "ansible_mounts": [
            {
                "block_available": 5886894, 
                "block_size": 4096, 
                "block_total": 10055888, 
                "block_used": 4168994, 
                "device": "/dev/sda3", 
                "fstype": "xfs", 
                "inode_available": 39877031, 
                "inode_total": 40243200, 
                "inode_used": 366169, 
                "mount": "/etc/hostname", 
                "options": "rw,seclabel,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota,bind", 
                "size_available": 24112717824, 
                "size_total": 41188917248, 
                "uuid": "daec0eb0-26cf-43cb-bcb1-896cdc193242"
            }, 
            {
                "block_available": 5886894, 
                "block_size": 4096, 
                "block_total": 10055888, 
                "block_used": 4168994, 
                "device": "/dev/sda3", 
                "fstype": "xfs", 
                "inode_available": 39877031, 
                "inode_total": 40243200, 
                "inode_used": 366169, 
                "mount": "/etc/resolv.conf", 
                "options": "rw,seclabel,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota,bind", 
                "size_available": 24112717824, 
                "size_total": 41188917248, 
                "uuid": "daec0eb0-26cf-43cb-bcb1-896cdc193242"
            }, 
            {
                "block_available": 5886894, 
                "block_size": 4096, 
                "block_total": 10055888, 
                "block_used": 4168994, 
                "device": "/dev/sda3", 
                "fstype": "xfs", 
                "inode_available": 39877031, 
                "inode_total": 40243200, 
                "inode_used": 366169, 
                "mount": "/etc/hosts", 
                "options": "rw,seclabel,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota,bind", 
                "size_available": 24112717824, 
                "size_total": 41188917248, 
                "uuid": "daec0eb0-26cf-43cb-bcb1-896cdc193242"
            }
        ], 
        "ansible_nodename": "63c835d7627e", 
        "ansible_os_family": "RedHat", 
        "ansible_pkg_mgr": "yum", 
        "ansible_proc_cmdline": {
            "BOOT_IMAGE": "/boot/vmlinuz-5.4.17-2136.301.1.3.el7uek.x86_64", 
            "LANG": "en_US.UTF-8", 
            "console": [
                "tty0", 
                "ttyS0,115200"
            ], 
            "crash_kexec_post_notifiers": true, 
            "crashkernel": "auto", 
            "ip": "single-dhcp", 
            "ipmi_si.tryacpi": "0", 
            "ipmi_si.trydmi": "0", 
            "iscsi_param": "node.session.timeo.replacement_timeout=6000", 
            "libiscsi.debug_libiscsi_eh": "1", 
            "loglevel": "4", 
            "net.ifnames": "1", 
            "netroot": "iscsi:169.254.0.2:::1:iqn.2015-02.oracle.boot:uefi", 
            "nvme_core.shutdown_timeout": "10", 
            "rd.dm": "0", 
            "rd.iscsi.bypass": "1", 
            "rd.luks": "0", 
            "rd.lvm": "0", 
            "rd.md": "0", 
            "ro": true, 
            "root": "UUID=daec0eb0-26cf-43cb-bcb1-896cdc193242"
        }, 
        "ansible_processor": [
            "0", 
            "AuthenticAMD", 
            "AMD EPYC 7551 32-Core Processor", 
            "1", 
            "AuthenticAMD", 
            "AMD EPYC 7551 32-Core Processor"
        ], 
        "ansible_processor_cores": 1, 
        "ansible_processor_count": 1, 
        "ansible_processor_threads_per_core": 2, 
        "ansible_processor_vcpus": 2, 
        "ansible_product_name": "Standard PC (i440FX + PIIX, 1996)", 
        "ansible_product_serial": "NA", 
        "ansible_product_uuid": "NA", 
        "ansible_product_version": "pc-i440fx-4.2", 
        "ansible_python": {
            "executable": "/usr/bin/python", 
            "has_sslcontext": true, 
            "type": "CPython", 
            "version": {
                "major": 2, 
                "micro": 5, 
                "minor": 7, 
                "releaselevel": "final", 
                "serial": 0
            }, 
            "version_info": [
                2, 
                7, 
                5, 
                "final", 
                0
            ]
        }, 
        "ansible_python_version": "2.7.5", 
        "ansible_real_group_id": 1000, 
        "ansible_real_user_id": 1000, 
        "ansible_selinux": {
            "status": "Missing selinux Python library"
        }, 
        "ansible_selinux_python_present": false, 
        "ansible_service_mgr": "systemd", 
        "ansible_ssh_host_key_dsa_public": "AAAAB3NzaC1kc3MAAACBANKE13MXeSNx8glc955+hYSWQIgkf/BNE3ZFHLPIwAKxkWjfZj/yWouQX8eb+Z6k8h2iiipfq+m6X6c1OtsKwgYkijBvag//SBHDA1LLEN5oOFIKNBglsuRFuSCReZqUo5jxul1XiLbqoieu+0aUV5yQd1oMoueWYZJrLR7eaxPTAAAAFQC+kY0+j1rECJ9v4jBdaWi/MDe4iwAAAIBe71RJb0GzjMfqMhYwGGZ7vNL5s2A3wu7IIjKg935xrAL9172JFNPU37+e4QEwK0qsKI8NUCg6xsgxsfNzgwrx45ntuBZx7Kx5xjOLQs7kSqMz7TENHxlgULNMbwB8PP1PPpa1oP9+6NU/tmfdc62FajTXU/cfuGkEy2QCHMKIigAAAIBrP8FGHxqqlK2Eiy7Oqwo0FFS5GW4hMWs5LnxXtJmuEo4AU0vo9ajIKtnPfdM7bboyo5KqwKMFmxjohvFK3qCovPJO/InlRE4+T9zinGxA+4PoGA7lqu7+TbO27RBD9NdWxXMH4eM65SZBGkGdD6OYe64G2fhV/xMYVVPWzA34rA==", 
        "ansible_ssh_host_key_ecdsa_public": "AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIYjUTtlPIlBbsoZKWrY/CPe1kXjwWWmLpwvBxOe328GY1d3OsCMszhiw763YsclwoYBbsj7Oc7Px7LwbkCGJkA=", 
        "ansible_ssh_host_key_ed25519_public": "AAAAC3NzaC1lZDI1NTE5AAAAIJ3EGpSiMlj4BqCjDnMZSRwztiglSxWhs1KsdBjhk9tY", 
        "ansible_ssh_host_key_rsa_public": "AAAAB3NzaC1yc2EAAAADAQABAAABAQC/ZbxB0jEkVPS8Crg4MTXhkxSOk2CiGlF1MEvV9/pNlJO496SvyTnhcq9fKt7fIQ7oLI1+6P7R5nuYs+RgXvgch9r5ChcWQZCmvShHSTxW0GpMBx0nncpaKJSApjN1oyvJ10U4NUCv7Kd3i87MY8kX4bUkYQTgY1ENrJldYA7iyDEeCFlpD0SaHMcypXZg4EA6URQTScWsGFkAlLGKBR+hfAolYtF42H0hjesAInZeRiET4WUvxbikqd3T0sKlbJV6Fd9JEIQsRHLufnqyfIxFhFXYUl6OeKIGAu9zjsSCR8G0hvMSIGp0XDDMW6kgBFD+w4AimF7qfqnPiRQqkuWp", 
        "ansible_swapfree_mb": 7838, 
        "ansible_swaptotal_mb": 8191, 
        "ansible_system": "Linux", 
        "ansible_system_capabilities": [
            ""
        ], 
        "ansible_system_capabilities_enforced": "True", 
        "ansible_system_vendor": "QEMU", 
        "ansible_uptime_seconds": 3785979, 
        "ansible_user_dir": "/home/vagrant", 
        "ansible_user_gecos": "", 
        "ansible_user_gid": 1000, 
        "ansible_user_id": "vagrant", 
        "ansible_user_shell": "/bin/bash", 
        "ansible_user_uid": 1000, 
        "ansible_userspace_architecture": "x86_64", 
        "ansible_userspace_bits": "64", 
        "ansible_virtualization_role": "guest", 
        "ansible_virtualization_type": "docker", 
        "discovered_interpreter_python": "/usr/bin/python", 
        "gather_subset": [
            "all"
        ], 
        "module_setup": true
    }, 
    "changed": false
}
[opc@instance-20220112-0945 Chapter02]$ 
```



```bash
[opc@instance-20220112-0945 Chapter02]$ cat setup_variables.yaml
---
- hosts: all
  remote_user: vagrant
  tasks: 
    - name: Print OS and version
      debug:
        msg: '{{ ansible_distribution }} {{ ansible_distribution_version }}'
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook -i test01.fale.io, setup_variables.yaml

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Print OS and version] *************************************************************************************************************************************ok: [test01.fale.io] => {
    "msg": "CentOS 7.9"
}

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter02]$ 
```


```bash
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook -i test01.fale.io, cli_variables.yaml -e 'name=test01'
[WARNING]: Found variable using reserved name: name

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Print variable 'name'] ************************************************************************************************************************************ok: [test01.fale.io] => {
    "msg": "test01"
}

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter02]$
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook -i test01.fale.io, cli_variables.yaml

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Print variable 'name'] ************************************************************************************************************************************fatal: [test01.fale.io]: FAILED! => {"msg": "The task includes an option with an undefined variable. The error was: 'name' is undefined\n\nThe error appears to be in '/home/opc/Learning-Ansible-2.X-Third-Edition-master/Chapter02/cli_variables.yaml': line 5, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: Print variable 'name'\n      ^ here\n"}

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter02]$ 
```


[Chapter03 - Ansible 사용자 생성](https://subscription.packtpub.com/book/cloud-and-networking/9781789954333/3/ch03lvl1sec18/creating-the-ansible-user)

* ansible 사용자를 생성하고 SSH key인증 설정함.

```bash
[opc@instance-20220112-0945 Chapter03]$ cat ./firstrun.yaml 
--- 
- hosts: all 
  user: vagrant 
  tasks: 
    - name: Ensure ansible user exists 
      user: 
        name: ansible 
        state: present 
        comment: Ansible 
      become: True
    - name: Ensure ansible user accepts the SSH key 
      authorized_key: 
        user: ansible 
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        state: present 
      become: True
    - name: Ensure the ansible user is sudoer with no password required 
      lineinfile: 
        dest: /etc/sudoers 
        state: present 
        regexp: '^ansible ALL\=' 
        line: 'ansible ALL=(ALL) NOPASSWD:ALL' 
        validate: 'visudo -cf %s'
      become: True
[opc@instance-20220112-0945 Chapter03]$ ansible-playbook -i test01.fale.io, firstrun.yaml

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Ensure ansible user exists] *******************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure ansible user accepts the SSH key] ******************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure the ansible user is sudoer with no password required] **********************************************************************************************changed: [test01.fale.io]

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter03]$
```

[Chapter03 - 기본 서버 구성](https://subscription.packtpub.com/book/cloud-and-networking/9781789954333/3/ch03lvl1sec19/configuring-a-basic-server)

* EPEL 활성화
* SELinux용 Python 바인딩 설치
* 설치된 모든 패키지 업그레이드
* NTP 설치, 구성 및 실행되고 있는지 확인
* FirewallD가 존재하고 활성화되어 있는지 확인
* 맞춤형 MOTD 추가
* 호스트 이름 변경

**플레이북 검토**

```bash
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook common_tasks.yaml --list-tasks
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

playbook: common_tasks.yaml

  play #1 (all): all    TAGS: []
    tasks:
      Ensure EPEL is enabled    TAGS: []
      Ensure libselinux-python is present       TAGS: []
      Ensure libsemanage-python is present      TAGS: []
      Ensure we have last version of every package      TAGS: []
      Ensure NTP is installed   TAGS: []
      Ensure the timezone is set to UTC TAGS: []
      Ensure the NTP service is running and enabled     TAGS: []
      Ensure FirewallD is installed     TAGS: []
      Ensure FirewallD is running       TAGS: []
      Ensure SSH can pass the firewall  TAGS: []
      Ensure the MOTD file is present and updated       TAGS: []
      Ensure the hostname is the same of the inventory  TAGS: []
[opc@instance-20220112-0945 Chapter02]$ cat common_tasks.yaml
--- 
- hosts: all 
  remote_user: ansible
  tasks: 
    - name: Ensure EPEL is enabled 
      yum: 
        name: epel-release 
        state: present 
      become: True 
    - name: Ensure libselinux-python is present 
      yum: 
        name: libselinux-python  
        state: present 
      become: True 
    - name: Ensure libsemanage-python is present 
      yum: 
        name: libsemanage-python 
        state: present 
      become: True 
    - name: Ensure we have last version of every package 
      yum: 
        name: "*" 
        state: latest 
      become: True 
    - name: Ensure NTP is installed 
      yum: 
        name: ntp 
        state: present 
      become: True 
    - name: Ensure the timezone is set to UTC 
      file: 
        src: /usr/share/zoneinfo/GMT 
        dest: /etc/localtime 
        state: link 
      become: True 
    - name: Ensure the NTP service is running and enabled 
      service: 
        name: ntpd 
        state: started 
        enabled: True 
      become: True 
    - name: Ensure FirewallD is installed 
      yum: 
        name: firewalld 
        state: present 
      become: True 
    - name: Ensure FirewallD is running 
      service: 
        name: firewalld 
        state: started 
        enabled: True 
      become: True 
    - name: Ensure SSH can pass the firewall 
      firewalld: 
        service: ssh 
        state: enabled 
        permanent: True 
        immediate: True 
      become: True 
    - name: Ensure the MOTD file is present and updated 
      template: 
        src: motd 
        dest: /etc/motd 
        owner: root 
        group: root 
        mode: 0644 
      become: True 
    - name: Ensure the hostname is the same of the inventory 
      hostname: 
        name: "{{ inventory_hostname }}" 
      become: True 
[opc@instance-20220112-0945 Chapter02]$
```


```bash
[opc@instance-20220112-0945 Chapter02]$ ansible-playbook -i test01.fale.io, common_tasks.yaml

PLAY [all] ******************************************************************************************************************************************************
TASK [Gathering Facts] ******************************************************************************************************************************************ok: [test01.fale.io]

TASK [Ensure EPEL is enabled] ***********************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure libselinux-python is present] **********************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure libsemanage-python is present] *********************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure we have last version of every package] *************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure NTP is installed] **********************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure the timezone is set to UTC] ************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure the NTP service is running and enabled] ************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure FirewallD is installed] ****************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure FirewallD is running] ******************************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure SSH can pass the firewall] *************************************************************************************************************************ok: [test01.fale.io]

TASK [Ensure the MOTD file is present and updated] **************************************************************************************************************changed: [test01.fale.io]

TASK [Ensure the hostname is the same of the inventory] *********************************************************************************************************fatal: [test01.fale.io]: FAILED! => {"changed": false, "msg": "Command failed rc=1, out=, err=Could not set property: Failed to set static hostname: Device or resource busy\n"}

PLAY RECAP ******************************************************************************************************************************************************test01.fale.io             : ok=12   changed=10   unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

[opc@instance-20220112-0945 Chapter02]$ 
```

> hostname 변경할 때 오류가 나는 것은 컨테이너는 호스트 이름을 변경할 수 없기 때문

* 여기까지 했음

* https://subscription.packtpub.com/book/cloud-and-networking/9781789954333/3/ch03lvl1sec20/installing-and-configuring-a-web-server




## Error

### Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).

**증상**
```bash
[opc@instance-20220112-0945 Chapter02]$ ansible all -i test01.fale.io, -m ping
test01.fale.io | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).", 
    "unreachable": true
}
[opc@instance-20220112-0945 Chapter02]$
```

**원인**

SSH 사용자 이름이 없음 ( ansible 초기 설치 후 접속시도하는 경우 였음)
```
<test01.fale.io> ESTABLISH SSH CONNECTION FOR USER: None
```

**조치**
사용자 이름을 파라미터에 추가해서 실행

```bash
[opc@instance-20220112-0945 Chapter02]$ ansible all -i test01.fale.io, -u vagrant -m ping
test01.fale.io | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
[opc@instance-20220112-0945 Chapter02]$
```

**비고**

안될 때 상세 로그

```bash
[opc@instance-20220112-0945 Chapter02]$ ansible -vvv all -i test01.fale.io, -m ping
ansible 2.9.27
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u'/home/opc/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python2.7/site-packages/ansible
  executable location = /usr/bin/ansible
  python version = 2.7.5 (default, Mar 12 2021, 14:55:44) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44.0.3)]
Using /etc/ansible/ansible.cfg as config file
Parsed test01.fale.io, inventory source with host_list plugin
Skipping callback 'actionable', as we already have a stdout callback.
Skipping callback 'counter_enabled', as we already have a stdout callback.
Skipping callback 'debug', as we already have a stdout callback.
Skipping callback 'dense', as we already have a stdout callback.
Skipping callback 'dense', as we already have a stdout callback.
Skipping callback 'full_skip', as we already have a stdout callback.
Skipping callback 'json', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'null', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.
Skipping callback 'selective', as we already have a stdout callback.
Skipping callback 'skippy', as we already have a stdout callback.
Skipping callback 'stderr', as we already have a stdout callback.
Skipping callback 'unixy', as we already have a stdout callback.
Skipping callback 'yaml', as we already have a stdout callback.
META: ran handlers
<test01.fale.io> ESTABLISH SSH CONNECTION FOR USER: None
<test01.fale.io> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/home/opc/.ansible/cp/3129765f43 test01.fale.io '/bin/sh -c '"'"'echo ~ && sleep 0'"'"''
<test01.fale.io> (255, '', 'Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).\r\n')
test01.fale.io | UNREACHABLE! => {
    "changed": false, 
    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).", 
    "unreachable": true
}
[opc@instance-20220112-0945 Chapter02]$

```
